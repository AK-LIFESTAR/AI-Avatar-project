# =============================================================================
# Project A Prototype - Windows & Mac Installer Build
# =============================================================================
# This workflow builds installers for:
# 1. Windows (.exe installer via NSIS)
# 2. macOS (.dmg installer)
#
# Both include the Python backend compiled with PyInstaller.
# =============================================================================

name: Build Installers (Project A Prototype)

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # WINDOWS BUILD
  # ============================================
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyInstaller and dependencies
        shell: pwsh
        run: |
          Write-Host "Installing PyInstaller and build tools..." -ForegroundColor Cyan
          pip install --upgrade pip
          pip install pyinstaller

      - name: Install Backend Python Dependencies
        working-directory: Open-LLM-VTuber
        shell: pwsh
        run: |
          Write-Host "Installing backend dependencies..." -ForegroundColor Cyan
          pip install --index-url https://download.pytorch.org/whl/cpu torch
          if (Test-Path "requirements.txt") {
            $filtered = Get-Content requirements.txt | Where-Object { $_ -notmatch '^\s*torch==' }
            $filtered | Out-File -FilePath requirements-filtered.txt -Encoding ascii
            pip install -r requirements-filtered.txt
          }
          pip install silero-vad websockets

      - name: Prepare config files
        working-directory: Open-LLM-VTuber
        shell: pwsh
        run: |
          if (!(Test-Path "conf.yaml")) {
            if (Test-Path "config_templates/conf.default.yaml") {
              Copy-Item "config_templates/conf.default.yaml" "conf.yaml"
            }
          }

      - name: Build Backend with PyInstaller
        working-directory: Open-LLM-VTuber
        shell: pwsh
        run: |
          pyinstaller `
            --name "backend" `
            --onedir `
            --noconfirm `
            --clean `
            --console `
            --add-data "conf.yaml;." `
            --add-data "model_dict.json;." `
            --add-data "mcp_servers.json;." `
            --add-data "src;src" `
            --add-data "characters;characters" `
            --add-data "live2d-models;live2d-models" `
            --add-data "prompts;prompts" `
            --add-data "config_templates;config_templates" `
            --add-data "upgrade_codes;upgrade_codes" `
            --add-data "web_tool;web_tool" `
            --hidden-import "fastapi" `
            --hidden-import "uvicorn" `
            --hidden-import "uvicorn.logging" `
            --hidden-import "uvicorn.protocols" `
            --hidden-import "uvicorn.protocols.http" `
            --hidden-import "uvicorn.protocols.http.auto" `
            --hidden-import "uvicorn.protocols.websockets" `
            --hidden-import "uvicorn.protocols.websockets.auto" `
            --hidden-import "uvicorn.lifespan" `
            --hidden-import "uvicorn.lifespan.on" `
            --hidden-import "starlette" `
            --hidden-import "starlette.routing" `
            --hidden-import "starlette.middleware" `
            --hidden-import "pydantic" `
            --hidden-import "pydantic_core" `
            --hidden-import "websockets" `
            --hidden-import "httpx" `
            --hidden-import "openai" `
            --hidden-import "anthropic" `
            --hidden-import "edge_tts" `
            --hidden-import "torch" `
            --hidden-import "numpy" `
            --hidden-import "scipy" `
            --hidden-import "sounddevice" `
            --hidden-import "pydub" `
            --hidden-import "yaml" `
            --hidden-import "loguru" `
            --hidden-import "silero_vad" `
            --hidden-import "tiktoken" `
            --hidden-import "tiktoken_ext" `
            --hidden-import "tiktoken_ext.openai_public" `
            --hidden-import "multidict" `
            --hidden-import "yarl" `
            --hidden-import "aiohttp" `
            --hidden-import "anyio" `
            --hidden-import "sniffio" `
            --hidden-import "certifi" `
            --hidden-import "charset_normalizer" `
            --hidden-import "idna" `
            --hidden-import "urllib3" `
            --collect-all "torch" `
            --collect-all "silero_vad" `
            --collect-all "tiktoken" `
            run_server.py
          
          if (!(Test-Path "dist/backend/backend.exe")) {
            Write-Host "ERROR: PyInstaller build failed!" -ForegroundColor Red
            exit 1
          }
          
          # CRITICAL: Manually copy ALL data files since PyInstaller --add-data is completely unreliable
          Write-Host "Manually copying data files to ensure they're included..."
          
          # 1. Prompts folder
          Copy-Item -Path "prompts" -Destination "dist/backend/prompts" -Recurse -Force
          Write-Host "Prompts folder copied"
          
          # 2. model_dict.json (required for Live2D)
          Copy-Item -Path "model_dict.json" -Destination "dist/backend/model_dict.json" -Force
          Write-Host "model_dict.json copied"
          
          # 3. mcp_servers.json (required for MCP tools)
          Copy-Item -Path "mcp_servers.json" -Destination "dist/backend/mcp_servers.json" -Force
          Write-Host "mcp_servers.json copied"
          
          # 4. config_templates folder
          Copy-Item -Path "config_templates" -Destination "dist/backend/config_templates" -Recurse -Force
          Write-Host "config_templates folder copied"
          
          # 5. characters folder (avatar configs)
          if (Test-Path "characters") {
            Copy-Item -Path "characters" -Destination "dist/backend/characters" -Recurse -Force
            Write-Host "characters folder copied"
          }
          
          # 6. live2d-models folder (3D avatar models)
          if (Test-Path "live2d-models") {
            Copy-Item -Path "live2d-models" -Destination "dist/backend/live2d-models" -Recurse -Force
            Write-Host "live2d-models folder copied"
          }
          
          # 7. backgrounds folder (background images)
          if (Test-Path "backgrounds") {
            Copy-Item -Path "backgrounds" -Destination "dist/backend/backgrounds" -Recurse -Force
            Write-Host "backgrounds folder copied"
          }
          
          # 8. avatars folder (avatar images)
          if (Test-Path "avatars") {
            Copy-Item -Path "avatars" -Destination "dist/backend/avatars" -Recurse -Force
            Write-Host "avatars folder copied"
          }
          
          # 9. web_tool folder (web utilities)
          if (Test-Path "web_tool") {
            Copy-Item -Path "web_tool" -Destination "dist/backend/web_tool" -Recurse -Force
            Write-Host "web_tool folder copied"
          }
          
          # 10. frontend folder (web UI)
          if (Test-Path "frontend") {
            Copy-Item -Path "frontend" -Destination "dist/backend/frontend" -Recurse -Force
            Write-Host "frontend folder copied"
          }
          
          # Verify all critical files exist
          Write-Host "`n=== Verifying backend contents ===" 
          Get-ChildItem "dist/backend" -Name

      - name: Copy Backend to Electron
        shell: pwsh
        run: |
          $sourceDir = "Open-LLM-VTuber/dist/backend"
          $targetDir = "Open-LLM-VTuber-Web/backend-dist"
          
          if (Test-Path $targetDir) { Remove-Item -Recurse -Force $targetDir }
          Copy-Item -Path $sourceDir -Destination $targetDir -Recurse
          
          $confPath = Join-Path $targetDir "conf.yaml"
          if (!(Test-Path $confPath)) {
            $templatePath = "Open-LLM-VTuber/config_templates/conf.default.yaml"
            if (Test-Path $templatePath) { Copy-Item $templatePath $confPath }
          }
          
          $buildId = "${{ github.sha }}"
          $buildIdPath = Join-Path $targetDir "backend-build-id.txt"
          [System.IO.File]::WriteAllText($buildIdPath, $buildId, [System.Text.UTF8Encoding]::new($false))

      - name: Install Electron deps
        working-directory: Open-LLM-VTuber-Web
        run: npm ci

      - name: Build Windows installer (NSIS)
        working-directory: Open-LLM-VTuber-Web
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build
          npx electron-builder --win --config electron-builder.yml

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: Open-LLM-VTuber-Web/release/**/*-setup.exe
          retention-days: 30

  # ============================================
  # MAC BUILD
  # ============================================
  build-mac:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyInstaller and dependencies
        run: |
          echo "Installing PyInstaller and build tools..."
          pip install --upgrade pip
          pip install pyinstaller

      - name: Install Backend Python Dependencies
        working-directory: Open-LLM-VTuber
        run: |
          echo "Installing backend dependencies..."
          # Install PyTorch CPU version for Mac
          pip install torch torchvision torchaudio
          
          if [ -f "requirements.txt" ]; then
            grep -v "^torch==" requirements.txt > requirements-filtered.txt || cp requirements.txt requirements-filtered.txt
            pip install -r requirements-filtered.txt
          fi
          
          pip install silero-vad websockets

      - name: Prepare config files
        working-directory: Open-LLM-VTuber
        run: |
          if [ ! -f "conf.yaml" ]; then
            if [ -f "config_templates/conf.default.yaml" ]; then
              cp config_templates/conf.default.yaml conf.yaml
            fi
          fi

      - name: Build Backend with PyInstaller
        working-directory: Open-LLM-VTuber
        run: |
          pyinstaller \
            --name "backend" \
            --onedir \
            --noconfirm \
            --clean \
            --console \
            --add-data "conf.yaml:." \
            --add-data "model_dict.json:." \
            --add-data "mcp_servers.json:." \
            --add-data "src:src" \
            --add-data "characters:characters" \
            --add-data "live2d-models:live2d-models" \
            --add-data "prompts:prompts" \
            --add-data "config_templates:config_templates" \
            --add-data "upgrade_codes:upgrade_codes" \
            --add-data "web_tool:web_tool" \
            --hidden-import "fastapi" \
            --hidden-import "uvicorn" \
            --hidden-import "uvicorn.logging" \
            --hidden-import "uvicorn.protocols" \
            --hidden-import "uvicorn.protocols.http" \
            --hidden-import "uvicorn.protocols.http.auto" \
            --hidden-import "uvicorn.protocols.websockets" \
            --hidden-import "uvicorn.protocols.websockets.auto" \
            --hidden-import "uvicorn.lifespan" \
            --hidden-import "uvicorn.lifespan.on" \
            --hidden-import "starlette" \
            --hidden-import "starlette.routing" \
            --hidden-import "starlette.middleware" \
            --hidden-import "pydantic" \
            --hidden-import "pydantic_core" \
            --hidden-import "websockets" \
            --hidden-import "httpx" \
            --hidden-import "openai" \
            --hidden-import "anthropic" \
            --hidden-import "edge_tts" \
            --hidden-import "torch" \
            --hidden-import "numpy" \
            --hidden-import "scipy" \
            --hidden-import "sounddevice" \
            --hidden-import "pydub" \
            --hidden-import "yaml" \
            --hidden-import "loguru" \
            --hidden-import "silero_vad" \
            --hidden-import "tiktoken" \
            --hidden-import "tiktoken_ext" \
            --hidden-import "tiktoken_ext.openai_public" \
            --hidden-import "multidict" \
            --hidden-import "yarl" \
            --hidden-import "aiohttp" \
            --hidden-import "anyio" \
            --hidden-import "sniffio" \
            --hidden-import "certifi" \
            --hidden-import "charset_normalizer" \
            --hidden-import "idna" \
            --hidden-import "urllib3" \
            --collect-all "torch" \
            --collect-all "silero_vad" \
            --collect-all "tiktoken" \
            run_server.py
          
          if [ ! -f "dist/backend/backend" ]; then
            echo "ERROR: PyInstaller build failed!"
            exit 1
          fi
          
          # CRITICAL: Manually copy prompts folder since PyInstaller --add-data is unreliable
          # CRITICAL: Manually copy ALL data files since PyInstaller --add-data is completely unreliable
          echo "Manually copying data files to ensure they're included..."
          
          # 1. Prompts folder
          cp -R prompts dist/backend/prompts
          echo "Prompts folder copied"
          
          # 2. model_dict.json (required for Live2D)
          cp model_dict.json dist/backend/model_dict.json
          echo "model_dict.json copied"
          
          # 3. mcp_servers.json (required for MCP tools)
          cp mcp_servers.json dist/backend/mcp_servers.json
          echo "mcp_servers.json copied"
          
          # 4. config_templates folder
          cp -R config_templates dist/backend/config_templates
          echo "config_templates folder copied"
          
          # 5. characters folder (avatar configs)
          if [ -d "characters" ]; then
            cp -R characters dist/backend/characters
            echo "characters folder copied"
          fi
          
          # 6. live2d-models folder (3D avatar models)
          if [ -d "live2d-models" ]; then
            cp -R live2d-models dist/backend/live2d-models
            echo "live2d-models folder copied"
          fi
          
          # 7. backgrounds folder (background images)
          if [ -d "backgrounds" ]; then
            cp -R backgrounds dist/backend/backgrounds
            echo "backgrounds folder copied"
          fi
          
          # 8. avatars folder (avatar images)
          if [ -d "avatars" ]; then
            cp -R avatars dist/backend/avatars
            echo "avatars folder copied"
          fi
          
          # 9. web_tool folder (web utilities)
          if [ -d "web_tool" ]; then
            cp -R web_tool dist/backend/web_tool
            echo "web_tool folder copied"
          fi
          
          # 10. frontend folder (web UI)
          if [ -d "frontend" ]; then
            cp -R frontend dist/backend/frontend
            echo "frontend folder copied"
          fi
          
          # Verify all critical files exist
          echo ""
          echo "=== Verifying backend contents ===" 
          ls -la dist/backend/

      - name: Copy Backend to Electron
        run: |
          SOURCE_DIR="Open-LLM-VTuber/dist/backend"
          TARGET_DIR="Open-LLM-VTuber-Web/backend-dist"
          
          rm -rf "$TARGET_DIR"
          cp -R "$SOURCE_DIR" "$TARGET_DIR"
          
          if [ ! -f "$TARGET_DIR/conf.yaml" ]; then
            TEMPLATE="Open-LLM-VTuber/config_templates/conf.default.yaml"
            if [ -f "$TEMPLATE" ]; then
              cp "$TEMPLATE" "$TARGET_DIR/conf.yaml"
            fi
          fi
          
          echo "${{ github.sha }}" > "$TARGET_DIR/backend-build-id.txt"

      - name: Install Electron deps
        working-directory: Open-LLM-VTuber-Web
        run: npm ci

      - name: Build Mac installer (DMG)
        working-directory: Open-LLM-VTuber-Web
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm run build
          npx electron-builder --mac --config electron-builder.yml

      - name: Upload Mac installer
        uses: actions/upload-artifact@v4
        with:
          name: mac-installer
          path: |
            Open-LLM-VTuber-Web/release/**/*.dmg
            Open-LLM-VTuber-Web/release/**/*.zip
          retention-days: 30

  # ============================================
  # RELEASE (after both builds complete)
  # ============================================
  release:
    needs: [build-windows, build-mac]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Windows installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: installers/windows

      - name: Download Mac installer
        uses: actions/download-artifact@v4
        with:
          name: mac-installer
          path: installers/mac

      - name: List all installers
        run: |
          echo "=== Windows Installers ===" 
          find installers/windows -type f -name "*.exe" | head -20
          echo ""
          echo "=== Mac Installers ==="
          find installers/mac -type f \( -name "*.dmg" -o -name "*.zip" \) | head -20

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            installers/windows/**/*-setup.exe
            installers/mac/**/*.dmg
          tag_name: latest
          name: "üöÄ Project A Prototype - Download"
          prerelease: false
          body: |
            ## üì• Download Project A Prototype
            
            Choose the installer for your operating system:
            
            ---
            
            ### ü™ü Windows
            **Download:** `project-a-prototype-*-setup.exe`
            
            1. Download the `.exe` file
            2. Run the installer
            3. Follow the wizard
            4. Launch from desktop shortcut
            
            **Requirements:** Windows 10/11 (64-bit)
            
            ---
            
            ### üçé Mac
            **Download:** `project-a-prototype-*.dmg`
            
            1. Download the `.dmg` file
            2. Open the DMG
            3. Drag app to Applications folder
            4. Launch from Applications
            
            **Requirements:** macOS 11+ (Big Sur or later)
            
            ---
            
            ## üîë First Run
            - Enter your **OpenAI API key** when prompted
            - Configure language and avatar in settings
            
            ---
            
            **Build:** `${{ github.sha }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
